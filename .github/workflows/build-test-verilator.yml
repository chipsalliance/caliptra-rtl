
# docs: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions

name: Verilator

on:
  push:
    branches: ["main", "dev-goog", "dev-msft"]
  workflow_call:
    inputs:
      run_vltr:
        description: "Control parameter indicating if Verilator tests should be run or skipped"
        required: true
        type: string
        default: 'true'
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: 0
  RISCV_VERSION: v12.1.0
  VERILATOR_VERSION: v5.038
  PKG_CONFIG_PATH: /opt/verilator/share/pkgconfig

  # cache bust if needed
  CUSTOM_CACHE_BUSTER: cc6ba052de27

jobs:
  build_tools:
    name: Build Tools
    runs-on: ubuntu-22.04
    if: ${{ inputs.run_vltr == 'true' }}

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'

      - name: Restore Cargo index
        uses: actions/cache/restore@v3
        with:
          path: ~/.cargo/registry/index
          key: cargo-index-${{ hashFiles('Cargo.lock') }}

      - name: Restore verilator dir
        uses: actions/cache/restore@v3
        id: verilator_restore
        with:
          path: /opt/verilator
          key: verilator-${{ env.VERILATOR_VERSION }}-${{ env.CUSTOM_CACHE_BUSTER }}

      - name: Install verilator
        if: steps.verilator_restore.outputs.cache-hit != 'true'
        run: |
          sudo apt-get install -y \
            git help2man perl python3 make autoconf g++ flex bison ccache \
            numactl perl-doc libfl2 libfl-dev \
            zlib1g zlib1g-dev

          cd /tmp
          git clone https://github.com/verilator/verilator
          cd verilator
          git checkout "${VERILATOR_VERSION}"

          autoconf
          ./configure
          make -j6
          sudo make install

      - name: Save verilator dir
        uses: actions/cache/save@v3
        if: steps.verilator_restore.outputs.cache-hit != 'true'
        with:
          path: /opt/verilator
          key: verilator-${{ env.VERILATOR_VERSION }}-${{ env.CUSTOM_CACHE_BUSTER }}

      - name: Setup verilator path
        run: echo /opt/verilator/bin >> $GITHUB_PATH

      - name: Restore RISC-V Toolchain
        uses: actions/cache/restore@v3
        id: riscv_restore
        with:
          path: /opt/riscv
          key: riscv-${{ env.RISCV_VERSION }}-${{ env.CUSTOM_CACHE_BUSTER }}

      - name: Install RISC-V Toolchain
        if: steps.riscv_restore.outputs.cache-hit != 'true'
        run: |
          wget -O toolchain.tar.gz \
            https://github.com/chipsalliance/caliptra-tools/releases/download/gcc-v12.1.0/riscv64-unknown-elf.gcc-12.1.0.tar.gz
          tar -xzf toolchain.tar.gz -C /opt

      - name: Save riscv dir
        uses: actions/cache/save@v3
        if: steps.riscv_restore.outputs.cache-hit != 'true'
        with:
          path: /opt/riscv
          key: riscv-${{ env.RISCV_VERSION }}-${{ env.CUSTOM_CACHE_BUSTER }}

      - name: Setup riscv path
        run: echo /opt/riscv/bin >> $GITHUB_PATH

  build_matrix:
    name: Build Smoke Test matrix
    runs-on: ubuntu-22.04
    needs: build_tools
    if: ${{ inputs.run_vltr == 'true' }}
    outputs:
      test_names: ${{ steps.output-matrix.outputs.test_names }}
    env:
      EXCLUDE_TESTS: "smoke_test_clk_gating, smoke_test_cg_wdt, smoke_test_mbox_cg, smoke_test_kv_cg, smoke_test_doe_cg, smoke_test_dma, smoke_test_wdt_rst"

    steps:
      - uses: actions/checkout@v3

      - name: Install deps
        run: sudo apt-get update -qy && sudo apt-get install -qy python3-minimal python3-yaml

      - name: Build matrix
        id: output-matrix
        run: echo "test_names=$(python3 .github/scripts/build_tests_matrix.py)" >> $GITHUB_OUTPUT


  build_and_test:
    name: Verilator
    runs-on: ubuntu-22.04
    needs: build_matrix
    if: ${{ inputs.run_vltr == 'true' }}

    strategy:
      fail-fast: false
      matrix:
        test_name: ${{ fromJSON(needs.build_matrix.outputs.test_names) }}

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'

      - name: Restore verilator dir
        uses: actions/cache/restore@v3
        id: verilator_restore
        with:
          path: /opt/verilator
          key: verilator-${{ env.VERILATOR_VERSION }}-${{ env.CUSTOM_CACHE_BUSTER }}

      - name: Restore RISC-V Toolchain
        uses: actions/cache/restore@v3
        id: riscv_restore
        with:
          path: /opt/riscv
          key: riscv-${{ env.RISCV_VERSION }}-${{ env.CUSTOM_CACHE_BUSTER }}

      - name: Delay before retry
        if: steps.riscv_restore.outputs.cache-hit != 'true'
        run: |
          delay=$((RANDOM % 10 + 1))
          echo "Cache restore failed or cache not found. Waiting ${delay} seconds before retry..."
          sleep ${delay}

      - name: Restore RISC-V Toolchain (Retry)
        if: steps.riscv_restore.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v3
        id: riscv_restore_retry
        with:
          path: /opt/riscv
          key: riscv-${{ env.RISCV_VERSION }}-${{ env.CUSTOM_CACHE_BUSTER }}

      - name: Verify RISC-V Toolchain Restored
        run: |
          if [ -d "/opt/riscv/bin" ] && [ -x "/opt/riscv/bin/riscv64-unknown-elf-gcc" ]; then
            echo "✓ RISC-V GCC found"
            /opt/riscv/bin/riscv64-unknown-elf-gcc --version | head -1
          else
            echo "❌ RISC-V toolchain missing"
            ls -la /opt/riscv/bin || true
            exit 1
          fi

      - name: Install ccache
        run: |
          sudo apt-get install -y git ccache 

      - name: Setup paths
        run: |
          echo /opt/verilator/bin >> $GITHUB_PATH
          echo /opt/riscv/bin >> $GITHUB_PATH

      - name: Run Caliptra Verilator Smoke Test
        run: |
          CALIPTRA_ROOT=$(pwd)
          ADAMSBRIDGE_ROOT=$CALIPTRA_ROOT/submodules/adams-bridge
          export CALIPTRA_AXI4PC_DIR=$CALIPTRA_ROOT/src/integration/tb
          export CALIPTRA_PRIM_ROOT=$CALIPTRA_ROOT/src/caliptra_prim_generic
          export CALIPTRA_PRIM_MODULE_PREFIX=caliptra_prim_generic

          cd tools/scripts
          make verilator \
            CALIPTRA_ROOT=$CALIPTRA_ROOT \
            ADAMSBRIDGE_ROOT=$ADAMSBRIDGE_ROOT \
            CALIPTRA_PRIM_ROOT=$CALIPTRA_PRIM_ROOT \
            CALIPTRA_PRIM_MODULE_PREFIX=$CALIPTRA_PRIM_MODULE_PREFIX \
            TESTNAME=${{ matrix.test_name }} | tee output.log

          tail -n 30 output.log | grep "TESTCASE PASSED"


  verify_test_results:
    name: Verify Verilator Test Results
    runs-on: ubuntu-22.04
    needs: build_and_test
    if: ${{ !cancelled() }}

    steps:
      - name: Print Verilator Aggregated Result
        run: |
          echo "Run Verilator check has a result of [${{ inputs.run_vltr }}]"
          if [[ "${{ inputs.run_vltr }}" == "false" ]]; then
            exit 0
          fi
          echo "build_and_test has a result of [${{ needs.build_and_test.result }}]"
          if [[ "${{ needs.build_and_test.result }}" != "success" ]]; then
            exit 1
          fi
