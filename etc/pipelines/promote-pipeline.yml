# Copyright (C) Microsoft Corporation. All rights reserved.

trigger: none

# Point to another repository for the pipeline template
resources:
  repositories:
  - repository: templates
    type: git
    name: Ether/pipelines
variables:
- group: AHA_POC_Pipelines
# Provides caliptra-rtl-write-token
- group: Caliptra_Promote_Pipeline_Secrets
- group: Adamsbridge_Promote_Pipeline_Secrets
- name: derivedTargetBranchName
  value: $[ coalesce(variables['System.PullRequest.targetBranchName'], 'master') ]
# If true, this indicates that the user wishes to validate a Pull Request
# on the caliptra-rtl repository for the specified branch, with the specified target.
# If false, indicates a Pull Request is initiated on the internal ADO repository
# and this pipeline is used to verify it, or that a user wishes to manually
# run the pipeline on an ADO branch.
parameters:
- name: run_clp_github_val_flow
  displayName: Run Promote Pipeline to validate Caliptra GitHub PullRequest
  type: boolean
  default: false
- name: run_abr_github_val_flow
  displayName: Run Promote Pipeline to validate Adamsbridge GitHub PullRequest
  type: boolean
  default: false
- name: bypass_ado_branch_val
  displayName: CAUTION - this is a debug fallback option, and should not typically be used. Bypass ADO branch val.
  type: boolean
  default: false
- name: github_branch_name
  displayName: GitHub Merge Branch Name
  type: string
  default: '<insert-branch-name-here>'
- name: github_dest_name
  displayName: GitHub Merge Destination Name
  type: string
  default: 'main'
- name: run_clp_ss_github_val_flow
  displayName: Run Promote Pipeline to validate Caliptra SS GitHub PullRequest
  type: boolean
  default: false

stages:
- template: etc/pipelines/templates/promote-pipeline-template.yml@templates  # Template reference
  parameters:
    project: 'AHA_POC'
    repo_url: 'git@ssh.dev.azure.com:v3/ms-tsd/AHA_POC/Caliptra'
    target_branch: 'master'
    legal_header: false
    legal_header_warning: false

    # Run repo checks before invoking the actual test steps for earlier
    # detection of basic issues
    pre_test_timeout: 120
    pre_test_steps:
      # Fail if running both abr and clp flags were selected
      - script: |
          echo "More than one Github val flags were set for Caliptra SS, ABR and CLP, these are mutex"
          exit 1
        displayName: 'Boolean flags should be mutex'
        enabled: True
        condition: ${{ and(parameters.run_clp_github_val_flow, parameters.run_abr_github_val_flow, parameters.run_clp_ss_github_val_flow) }}
      # Fail if running a GitHub validation pipeline on any branch other than master
      - script: |
          echo "Used invalid ADO branch [${BUILD_SOURCEBRANCHNAME}] to run promote pipeline when attempting to validate a GitHub Pull Request. Use 'master'"
          exit 1
        displayName: 'Evaluate build branch validity'
        enabled: ${{ and(or(parameters.run_clp_github_val_flow, parameters.run_abr_github_val_flow, parameters.run_clp_ss_github_val_flow),not(parameters.bypass_ado_branch_val)) }}
        condition: and(eq(variables['Build.Reason'], 'Manual'), ne(variables['Build.SourceBranchName'], 'master'))
      

      # Create a merged branch in caliptra-rtl representing the result of the Pull Request
      # when running validation for GitHub PR
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          enter-workspace tmp_ws "echo \"running \$MSFT_REPO_ROOT/tools/scripts/promote_create_merge_branch.sh with ${{ parameters.github_dest_name }}, ${{ parameters.github_branch_name }}\" && bash \$MSFT_REPO_ROOT/tools/scripts/promote_create_merge_branch.sh ${{ parameters.github_dest_name }} ${{ parameters.github_branch_name }} && echo \"Done - check \$CALIPTRA_ROOT\""
        displayName: 'CREATE MERGED TEST BRANCH'
        enabled: ${{ parameters.run_clp_github_val_flow }}
        condition: eq(variables['Build.Reason'], 'Manual')
        timeoutInMinutes: 10


      # Create a merged branch in adams-bridge representing the result of the Pull Request
      # when running validation for GitHub PR
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          enter-workspace tmp_ws "echo \"running \$MSFT_REPO_ROOT/tools/scripts/promote_create_abr_merge_branch.sh with ${{ parameters.github_dest_name }}, ${{ parameters.github_branch_name }}\" && bash \$MSFT_REPO_ROOT/tools/scripts/promote_create_abr_merge_branch.sh ${{ parameters.github_dest_name }} ${{ parameters.github_branch_name }} && echo \"Done - check \$ADAMSBRIDGE_ROOT\""
        displayName: 'CREATE MERGED TEST BRANCH'
        enabled: ${{ parameters.run_abr_github_val_flow }}
        condition: eq(variables['Build.Reason'], 'Manual')
        timeoutInMinutes: 10

      # Create a merged branch in caliptra-ss representing the result of the Pull Request
      # when running validation for GitHub PR
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          enter-workspace tmp_ws "echo \"running \$MSFT_REPO_ROOT/tools/scripts/promote_create_cptra_ss_merge_branch.sh with ${{ parameters.github_dest_name }}, ${{ parameters.github_branch_name }}\" && bash \$MSFT_REPO_ROOT/tools/scripts/promote_create_merge_branch.sh ${{ parameters.github_dest_name }} ${{ parameters.github_branch_name }} && echo \"Done - check \$CALIPTRA_SS\""
        displayName: 'CREATE MERGED TEST BRANCH'
        enabled: ${{ parameters.run_clp_ss_github_val_flow }}
        condition: eq(variables['Build.Reason'], 'Manual')
        timeoutInMinutes: 20

      # License Header check and RDL check are run natively on GitHub Actions for caliptra-rtl
      # Pull Requests. Only run them here for internal ADO PRs and manual runs without a github target.
      # TODO: enable license check on adams-bridge github
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          # Run the license checker script
          enter-workspace tmp_ws 'echo "running $MSFT_REPO_ROOT/tools/scripts/licenseHeaderCheck.sh" && cd $MSFT_REPO_ROOT && bash $MSFT_REPO_ROOT/tools/scripts/licenseHeaderCheck.sh'
  
        displayName: 'LICENSE_HEADER_CHECK'
        enabled: ${{ and(not(parameters.run_clp_github_val_flow),not(parameters.run_abr_github_val_flow), not(parameters.run_clp_ss_github_val_flow))}}
        timeoutInMinutes: 5
        env:
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          # Install (locally) necessary Python modules for RDL regeneration
          pip install --user \
              systemrdl-compiler==1.27.3 \
              peakrdl-systemrdl==0.3.0 \
              peakrdl-regblock==0.21.0 \
              peakrdl-uvm==2.3.0 \
              peakrdl-ipxact==3.4.3 \
              peakrdl-html==2.10.1 \
              peakrdl-cheader==1.0.0 \
              peakrdl==1.1.0

          # Run the RDL file checker script
          enter-workspace tmp_ws 'echo "running $MSFT_REPO_ROOT/tools/scripts/promote_rdl_check.sh" && bash $MSFT_REPO_ROOT/tools/scripts/promote_rdl_check.sh $(derivedTargetBranchName)'
  
        displayName: 'RDL GEN CHECK'
        enabled: ${{ and(not(parameters.run_clp_github_val_flow),not(parameters.run_abr_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
        timeoutInMinutes: 30
        env:
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)

      # Run file list check with no GH ref name argument for ADO Pull Requests (GitHub ref will be derived in script)
      # Run file list check with GitHub ref override in caliptra-rtl when validating GitHub Pull Requests
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"

          # Run the Filelist generator script
          if [[ (${BUILD_REASON} == 'PullRequest') || ( "${{ parameters.run_clp_github_val_flow }}" == "false" ) ]]; then
              enter-workspace tmp_ws 'echo "running $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh" && bash $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh $(derivedTargetBranchName)'
          else
              enter-workspace tmp_ws 'echo "running $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh" && bash $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh $(derivedTargetBranchName) "chips/${{ parameters.github_dest_name }}"'
          fi

        displayName: 'FILE LIST CHECK'
        enabled: ${{ and(not(parameters.run_abr_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
        timeoutInMinutes: 90
  
      # Run file list check with no GH ref name argument for ADO Pull Requests (GitHub ref will be derived in script)
      # Run file list check with GitHub ref override in adams-bridge when validating GitHub Pull Requests
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"

          # Run the Filelist generator script
          if [[ (${BUILD_REASON} == 'PullRequest') || ( "${{ parameters.run_abr_github_val_flow }}" == "false" ) ]]; then
              enter-workspace tmp_ws 'echo "running $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh" && bash $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh $(derivedTargetBranchName) derived abr'
          else
              enter-workspace tmp_ws 'echo "running $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh" && bash $MSFT_REPO_ROOT/tools/scripts/promote_file_list_check.sh $(derivedTargetBranchName) "chips/${{ parameters.github_dest_name }}" abr'
          fi

        displayName: 'FILE LIST CHECK ABR'
        enabled: ${{ and(not(parameters.run_clp_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
        timeoutInMinutes: 90
  
    build_and_sim_map:
    - integration_top_vcs:
      - display_name: 'Build integration_lib with VCS'
      - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
      - configspec_name: 'integration_lib'
      - dut: 'caliptra_top_tb'
      - args: ''
      - timeout: 30
      - testsuites:
        - l0_regress:
          - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
          - configspec_name: 'integration_lib'
          - dut: 'caliptra_top_tb'
          - timeout: 90
          - path: '${CALIPTRA_ROOT}/src/integration/stimulus/L0_regression.yml'

    - integration_top_trng_vcs:
      - display_name: 'Build integration_lib with VCS and enable TRNG'
      - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
      - configspec_name: 'integration_lib'
      - dut: 'caliptra_top_trng_tb'
      - args: ''
      - timeout: 30
      - testsuites:
        - l0_trng_regress:
          - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
          - configspec_name: 'integration_lib'
          - dut: 'caliptra_top_trng_tb'
          - timeout: 45
          - path: '${CALIPTRA_ROOT}/src/integration/stimulus/L0_trng_regression.yml'
    
    - caliptra_ss_top_vcs:
     - display_name: 'Build caliptra_ss_top with VCS'
     - enabled: ${{ parameters.run_clp_ss_github_val_flow}}
     - configspec_name: 'caliptra_ss_lib'
     - dut: 'caliptra_ss_top'
     - args: ''
     - timeout: 30
     - testsuites:
       - l0_regress:
         - enabled: ${{ parameters.run_clp_ss_github_val_flow }}
         - configspec_name: 'caliptra_ss_lib'
         - dut: 'caliptra_ss_top'
         - timeout: 75
         - path: '${CALIPTRA_SS}/src/integration/stimulus/L0_regression.yml'
# ===================================== AXI FIXME =====================================
# == Reenable these checks once UVM env is updated to AXI
#    - uvmf_soc_ifc:
#        - display_name: 'UVMF_SOC_IFC'
#        - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
#        - configspec_name: 'integration_lib'
#        - dut: 'uvmf_soc_ifc'
#        #- args: '--submit-resource-args RAM/28000'
#        - timeout: 25
#        - testsuites:
#          - l0_regress:
#            - enabled: true
#            - configspec_name: 'integration_lib'
#            - dut: 'uvmf_soc_ifc'
#            - sim_args: '+CLP_REGRESSION +CLP_SHORT_SUITE +CLP_SEQ=soc_ifc_env_top_mbox_rand_small_sequence +CLP_SEQ=soc_ifc_env_top_mbox_rst_warm_rand_medium_sequence +CLP_SEQ=soc_ifc_env_cptra_init_interrupts_sequence +CLP_SEQ=soc_ifc_env_top_mbox_reg_axs_invalid_medium_sequence'
#            - path: '${CALIPTRA_ROOT}/src/soc_ifc/stimulus/testsuites/uvmf_soc_ifc_promote_regression.yml'
#            - timeout: 1440
#
#    - uvmf_caliptra_top:
#        - display_name: 'UVMF_CALIPTRA_TOP'
#        - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
#        - configspec_name: 'integration_lib'
#        - dut: 'uvmf_caliptra_top'
#        #- args: '--submit-resource-args RAM/28000'
#        - timeout: 25
#        - testsuites:
#          - l0_regress:
#            - enabled: true
#            - configspec_name: 'integration_lib'
#            - dut: 'uvmf_caliptra_top'
#            - sim_args: '+CLP_REGRESSION +CLP_SHORT_SUITE +CLP_SEQ=soc_ifc_env_mbox_rand_small_sequence +CLP_SEQ=soc_ifc_env_mbox_rst_warm_rand_medium_sequence +CLP_SEQ=CLP_RERUN_FW_INIT +CLP_SEQ=soc_ifc_env_mbox_rand_medium_interference_sequence +CLP_SEQ=soc_ifc_env_mbox_fw_upd_sequence'
#            - path: '${CALIPTRA_ROOT}/src/integration/stimulus/testsuites/uvmf_caliptra_top_promote_regression.yml'
#            - timeout: 1440
# ===================================== END AXI FIXME =====================================

    - integration_top_ius:
      - display_name: 'Build integration_lib with IUS/Xcelium'
      - enabled: false
      - configspec_name: 'integration_lib'
      - dut: 'caliptra_top'
      - args: '--tool ius --targets packages rtl elab --options rtl="+define+TSD_DISABLE_ASSERTIONS"'
      - timeout: 10

    - uvmf_mldsa:
        - display_name: 'UVMF_MLDSA'
        - enabled: ${{ and(not(parameters.run_clp_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
        - configspec_name: 'adams_bridge_lib'
        - dut: 'uvmf_mldsa'
        - timeout: 25
        - testsuites:
          - l0_regress:
            - enabled: ${{ not(parameters.run_clp_github_val_flow) }}
            - configspec_name: 'adams_bridge_lib'
            - dut: 'uvmf_mldsa'
            - path: '${ADAMSBRIDGE_ROOT}/src/mldsa_top/stimulus/uvmf_mldsa_top_promote_regression.yml'
            - timeout: 1440

    - uvmf_kv:
      - display_name: 'UVMF_KV'
      - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
      - configspec_name: 'integration_lib'
      - dut: 'uvmf_kv'
      #- args: '--submit-resource-args RAM/28000'
      - timeout: 25
      - testsuites:
        - l0_regress:
          - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
          - configspec_name: 'integration_lib'
          - dut: 'uvmf_kv'
          - path: '${CALIPTRA_ROOT}/src/keyvault/stimulus/testsuites/kv_promote_regression.yml'
          - timeout: 1440

    - uvmf_pv:
      - display_name: 'UVMF_PV'
      - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
      - configspec_name: 'integration_lib'
      - dut: 'uvmf_pv'
      #- args: '--submit-resource-args RAM/28000'
      - timeout: 25
      - testsuites:
        - l0_regress:
          - enabled: ${{ not(parameters.run_abr_github_val_flow) }}
          - configspec_name: 'integration_lib'
          - dut: 'uvmf_pv'
          - path: '${CALIPTRA_ROOT}/src/pcrvault/stimulus/testsuites/pv_promote_regression.yml'
          - timeout: 1440

    design_lint_map:
    - caliptra_top_sglint:
      - enabled: ${{ and(not(parameters.run_abr_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
      - configspec_name: 'integration_lib'
      - dut: 'caliptra_top'
      - top: 'caliptra_top'
      - lint_tool: 'sglint'
      - timeout: 45
      - args: '--inherit-waivers=True --waivers-from-compile-yml --goal=caliptra_lint_rtl_msft --platform synth'

    - mldsa_top_sglint:
      - enabled: ${{ and(not(parameters.run_clp_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
      - configspec_name: 'adams_bridge_lib'
      - dut: 'mldsa_top'
      - top: 'mldsa_top'
      - lint_tool: 'sglint'
      - timeout: 45
      - args: '--inherit-waivers=True --waivers-from-compile-yml --goal=caliptra_lint_rtl_msft --platform synth'

    - caliptra_ss_top_sglint:
      - enabled: ${{ and(not(parameters.run_clp_github_val_flow), not(parameters.run_abr_github_val_flow)) }}
      - configspec_name: 'caliptra_ss_lib'
      - dut: 'caliptra_ss_top'
      - top: 'caliptra_ss_top'
      - lint_tool: 'sglint'
      - timeout: 45
      - args: '--inherit-waivers=True --waivers-from-compile-yml --goal=caliptra_lint_rtl_msft --platform synth'

    dv_lint_map:
    - caliptra_top_tb:
      - enabled: false
      - configspec_name: 'integration_lib'
      - dut: 'caliptra_top_tb'
      - timeout: 10

    top_repo: ''

    additional_test_steps:
      # This step is run natively on GitHub Actions for caliptra-rtl
      # Pull Requests. Only run here for internal ADO PRs.
      - verilator_smoke_test:
        - display_name: 'Verilator Smoke Test'
        - enabled: ${{ and(not(parameters.run_clp_github_val_flow),not(parameters.run_abr_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
        - run_in_workspace: True
        - timeout: 240
        - commands:
            - 'set -e'
            - 'module load tools/python/python3/3.9.2'

            # Run the Verilator test regression and dump logfiles to scratch
            - 'submit -i python3 \$CALIPTRA_SCRIPTS_DIR/run_verilator_l0_regression.py'

      - caliptra_synthesis_elab_check:
        - display_name: 'Caliptra Synthesis Elab Check'
        - enabled: ${{ and(not(parameters.run_abr_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
        - run_in_workspace: True
        - timeout: 25
        - commands:
          - 'set -e'
          - 'module load tools/python/python3/3.9.2'
          - 'module load tools/synopsys/fusion_compiler/2022.12-SP3'

          # Run synthesis on top level and exit after elaborate stage
          - 'submit -i --container None python3 \$MSFT_SCRIPTS_DIR/syn/run_syn.py caliptra_top 1'

      - adamsbridge_synthesis_elab_check:
        - display_name: 'Adamsbridge Synthesis Elab Check'
        - enabled: ${{ and(not(parameters.run_clp_github_val_flow), not(parameters.run_clp_ss_github_val_flow)) }}
        - run_in_workspace: True
        - timeout: 25
        - commands:
          - 'set -e'
          - 'module load tools/python/python3/3.9.2'
          - 'module load tools/synopsys/fusion_compiler/2022.12-SP3'

          # Run synthesis on top level and exit after elaborate stage
          - 'submit -i --container None python3 \$MSFT_SCRIPTS_DIR/syn/run_syn.py mldsa_top 1'

      - caliptra_ss_synthesis_elab_check:
        - display_name: 'Caliptra SS Synthesis Elab Check'
        - enabled: ${{ and(not(parameters.run_abr_github_val_flow), not(parameters.run_clp_github_val_flow)) }}
        - run_in_workspace: True
        - timeout: 25
        - commands:
          - 'set -e'
          - 'module load tools/python/python3/3.9.2'
          - 'module load tools/synopsys/fusion_compiler/2022.12-SP3'

          # Run synthesis on top level and exit after elaborate stage
          - 'submit -i --container None python3 \$MSFT_SCRIPTS_DIR/syn/run_syn.py caliptra_ss_top 1'

    post_test_steps:
      # If this pipeline was run to validate an internal ADO Pull Request, finalize
      # by clobbering the (large) Verilator regression scratch area.
      # This step will be skipped for failing regressions, so the Verilator scratch
      # will persist to aid debug in that case.
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          enter-workspace tmp_ws "echo \"clobbering \$CALIPTRA_WORKSPACE/scratch/\$USER/verilator/latest/*\" && rm -rf \$(realpath \$CALIPTRA_WORKSPACE/scratch/\$USER/verilator/latest) && rm \$CALIPTRA_WORKSPACE/scratch/\$USER/verilator/latest"
        displayName: 'CLOBBER VERILATOR REGRESSION OUTPUT'
        enabled: true
        condition: eq(variables['Build.Reason'], 'PullRequest')
        timeoutInMinutes: 20
      # If this pipeline was run to validate a CLP GitHub Pull Request, finalize by
      # updating the timestamp and file list hash on the target branch and pushing
      # to GitHub. This allows the GitHub Action to succeed for that PR
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          enter-workspace tmp_ws "echo \"running \$MSFT_REPO_ROOT/tools/scripts/promote_stamp_target_branch.sh with ${{ parameters.github_branch_name }}\" && bash \$MSFT_REPO_ROOT/tools/scripts/promote_stamp_target_branch.sh ${{ parameters.github_branch_name }} $(caliptra-rtl-write-token)"
        displayName: 'STAMP MERGE BRANCH'
        enabled: ${{ parameters.run_clp_github_val_flow }}
        condition: eq(variables['Build.Reason'], 'Manual')
        timeoutInMinutes: 10
      # If this pipeline was run to validate an ABR GitHub Pull Request, finalize by
      # updating the timestamp and file list hash on the target branch and pushing
      # to GitHub. This allows the GitHub Action to succeed for that PR
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          enter-workspace tmp_ws "echo \"running \$MSFT_REPO_ROOT/tools/scripts/promote_stamp_target_abr_branch.sh with ${{ parameters.github_branch_name }}\" && bash \$MSFT_REPO_ROOT/tools/scripts/promote_stamp_target_abr_branch.sh ${{ parameters.github_branch_name }} $(adams-bridge-write-token)"
        displayName: 'STAMP MERGE BRANCH'
        enabled: ${{ parameters.run_abr_github_val_flow }}
        condition: eq(variables['Build.Reason'], 'Manual')
        timeoutInMinutes: 10

      # If this pipeline was run to validate a CLP SS GitHub Pull Request, finalize by
      # updating the timestamp and file list hash on the target branch and pushing
      # to GitHub. This allows the GitHub Action to succeed for that PR
      - script: |
          source /home/continuous_integration/release/enviro/etc/enviro_startup.bash
          module load settings/tsd/pipelines/frontend
          module load tools/python/python3/3.9.2
          export PYREQUIREMENTS="$(workspace_root)/pipelines/require-progress.txt"
          PROGRESS_CONFIG="$(workspace_root)/progress/config.json"
  
          enter-workspace tmp_ws "echo \"running \$MSFT_REPO_ROOT/tools/scripts/promote_stamp_target_branch.sh with ${{ parameters.github_branch_name }}\" && bash \$MSFT_REPO_ROOT/tools/scripts/promote_stamp_target_branch.sh ${{ parameters.github_branch_name }} $(caliptra-rtl-write-token)"
        displayName: 'STAMP MERGE BRANCH'
        enabled: ${{ parameters.run_clp_ss_github_val_flow }}
        condition: eq(variables['Build.Reason'], 'Manual')
        timeoutInMinutes: 20
